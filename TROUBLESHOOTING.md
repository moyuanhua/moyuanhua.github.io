# 飞书权限问题排查清单

## 当前状态
- ✅ 应用凭证有效
- ✅ WIKI_ID 正确
- ❌ 权限错误 (131006): permission denied

## 逐步排查

### 1. 检查应用权限配置

访问: https://open.feishu.cn/app

选择应用: `cli_a8181d8827ead01c`

#### 查看权限管理:
- [ ] 是否添加了 `wiki:wiki:readonly` 权限?
- [ ] 是否添加了 `docx:document:readonly` 权限?
- [ ] 是否添加了 `drive:drive:readonly` 权限?

#### ⚠️ 关键步骤:
- [ ] 添加权限后,是否点击了 **"创建版本"** 或 **"发布版本"**?
- [ ] 版本状态是否为 **"已发布"** 或 **"审核通过"**?

**如果没有发布版本,权限不会生效!**

### 2. 检查机器人配置

#### 启用机器人:
- [ ] 进入应用的 **"应用功能"**
- [ ] 找到 **"机器人"** 选项
- [ ] 确认机器人功能已启用

### 3. 配置知识库访问 (最重要!)

#### 方式 A: 通过飞书群授权

1. **创建飞书群**:
   - [ ] 在飞书中创建一个新群 (或使用现有群)
   - [ ] 群名可以是 "Feishu Pages" 或任意名称

2. **添加机器人到群**:
   - [ ] 打开群聊
   - [ ] 群设置 → 群机器人 → 添加机器人
   - [ ] 搜索并添加你的应用机器人

3. **将群添加为知识库协作者**:
   - [ ] 访问知识库: https://or6tftpha8.feishu.cn/wiki/space/7560180515966484484
   - [ ] 点击右上角的 **"..."** 或 **"设置"**
   - [ ] 选择 **"权限管理"** 或 **"协作者"**
   - [ ] 点击 **"添加协作者"**
   - [ ] 搜索并添加刚才创建的群
   - [ ] 授予 **"可阅读"** 或 **"可编辑"** 权限

#### 方式 B: 直接添加应用 (如果支持)

某些企业版飞书支持直接添加应用:
- [ ] 知识库 → 设置 → 协作者
- [ ] 添加应用作为协作者
- [ ] 授予读取权限

### 4. 等待生效

配置完成后:
- [ ] 等待 1-2 分钟让权限同步
- [ ] 运行测试: `node scripts/diagnose-feishu.js`

### 5. 验证配置

运行测试脚本:

```bash
cd app
node scripts/diagnose-feishu.js
```

**成功的输出应该是**:
```
1️⃣ 检查环境变量:
   FEISHU_APP_ID: ✅ cli_a8181d8827ead01c
   FEISHU_APP_SECRET: ✅ mwC4jkHfxU...
   FEISHU_WIKI_ID: ✅ 7560180515966484484

2️⃣ 测试应用凭证:
   ✅ 应用凭证有效

3️⃣ 测试知识库访问权限:
   ✅ 成功访问知识库!
   找到 X 个节点

✅ 诊断完成 - 配置正确!
```

### 6. 常见错误

#### 错误 131006: permission denied
**原因**: 应用没有知识库访问权限
**解决**: 
1. 确认权限已添加且已发布版本
2. 确认机器人已添加到有权限的群
3. 确认群已添加为知识库协作者

#### 错误 131002: space_id is not int
**原因**: WIKI_ID 格式错误
**解决**: 使用纯数字格式的 ID (如 7560180515966484484)

#### Token 正常但还是 permission denied
**原因**: 权限配置正确,但没有发布版本
**解决**: 去应用管理后台,点击"创建版本"/"发布版本"

### 7. 重新开始

如果以上都不行,尝试:

1. **重新创建机器人**:
   - 删除当前机器人
   - 重新启用机器人功能

2. **重新生成密钥**:
   - 应用管理 → 凭证与基础信息
   - 重置 App Secret
   - 更新 `.env` 文件

3. **检查企业权限**:
   - 联系飞书管理员
   - 确认企业是否限制了机器人权限

### 8. 截图辅助

如果还是不行,请截图以下界面:

1. 应用 → 权限管理 → 已配置的权限列表
2. 应用 → 应用版本 → 当前版本状态
3. 知识库 → 设置 → 协作者列表
4. 测试脚本的完整输出

## 临时解决方案

如果暂时无法解决权限问题,可以:

```bash
# 在 .env 中设置
SKIP_FEISHU_SYNC=true

# 使用现有内容构建
npm run build
```

---

**需要帮助?** 查看飞书开放平台文档: https://open.feishu.cn/document/
